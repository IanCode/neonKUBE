#------------------------------------------------------------------------------
# Cheats for JEFF home environment.

#------------------------------------------------------------------------------
# [neon]: Ubuntu 16.04

neon logout
neon login rm root@home-small --force
powershell -file %NF_ROOT%\Devops\test\setup-all.ps1 home-small jeff-latest -noshim 

neon logout
neon login rm root@home-large --force
powershell -file %NF_ROOT%\Devops\test\setup-all.ps1 home-large jeff-latest -noshim

neon logout
neon login rm root@home-azure --force
powershell -file %NF_ROOT%\Devops\test\setup-all.ps1 home-azure jeff-latest -noshim

neon logout
neon login rm root@home-xen --force
powershell -file %NF_ROOT%\Devops\test\setup-all.ps1 home-xen jeff-latest -noshim

neon logout
neon login rm root@home-bare --force
powershell -file %NF_ROOT%\Devops\test\setup-all.ps1 home-bare jeff-latest -noshim

neon logout
neon login rm root@home-small --force
neon cluster prepare %NF_ROOT%\Devops\test\clusters\home-small\cluster.json --log-folder=c:\cluster-logs --max-parallel=10 --force --noshim
neon cluster setup --log-folder=c:\cluster-logs --max-parallel=10 --unredacted root@home-small --noshim --image-tag=jeff-latest
neon cluster set allow-unit-testing=true
# neon cluster setup --log-folder=c:\cluster-logs --max-parallel=10 --unredacted root@home-small --noshim

neon login rm root@home2-small --force
neon cluster prepare %NF_ROOT%\Devops\test\clusters\home2-small\cluster.json --log-folder=c:\cluster-logs --max-parallel=10 --force
neon cluster setup --log-folder=c:\cluster-logs --max-parallel=10 --unredacted root@home2-small --image-tag=jeff-latest --noshim
neon cluster set allow-unit-testing=true

#------------------------------------------------------------------------------
# RabbitMQ

sudo cat <<EOF > /usr/bin/sbash
# Starts Bash with elevated permissions while also inheriting
# the current environment variables.

/usr/bin/sudo -E bash \$@
EOF

sbash

echo mq > /etc/hostname
sed -i "s/ubuntu/mq/g" /etc/hosts
systemctl restart networking

chmod a+x /usr/bin/sbash

wget https://packages.erlang-solutions.com/erlang-solutions_1.0_all.deb
dpkg -i erlang-solutions_1.0_all.deb

wget https://packages.erlang-solutions.com/ubuntu/erlang_solutions.asc
apt-key add erlang_solutions.asc

apt-get update
apt-get install -yq esl-erlang socat

# $todo(jeff.lill): 
#
# Couldn't get High-Performance Erlang (HiPE) to install for better performnce.
# come back and investigate later.
#
# apt-get install erlang-base-hipe

curl -L http://www.rabbitmq.com/releases/rabbitmq-server/v3.6.10/rabbitmq-server_3.6.10-1_all.deb -o rabbitmq.deb
dpkg --install rabbitmq.deb

rabbitmq-plugins enable rabbitmq_management
rabbitmqctl add_user admin password
rabbitmqctl set_user_tags admin administrator

# Dashboard: http://10.0.0.93:15672
# UID/PWD:   admin/password

rm *.deb
